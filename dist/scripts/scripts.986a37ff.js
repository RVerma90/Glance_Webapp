"use strict";var glance=angular.module("GlanceApp",["ngAnimate","ngCookies","ngResource","ngRoute","ui.router","firebase","ngMaterial"]).constant("FURL","https://fiery-inferno-5671.firebaseio.com/").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("auth",{url:"/",templateUrl:"views/auth.html",controller:"AuthCtrl"}).state("glanceboard",{url:"/glanceboard/:uid",templateUrl:"views/glanceboard.html",controller:"GlanceCtrl",data:{stateName:"Glanceboard"},resolve:{currentAuth:["Auth",function(a){return a.requireAuth()}]}}).state("projects",{url:"/projects/:uid",templateUrl:"views/projects.html",controller:"ProjectsCtrl",data:{stateName:"Projects"},resolve:{currentAuth:["Auth",function(a){return a.requireAuth()}]}}).state("milestones",{url:"/milestones/:pid",templateUrl:"views/milestones.html",controller:"MilestonesCtrl",data:{stateName:"Milestones"},resolve:{currentAuth:["Auth",function(a){return a.requireAuth()}]}}).state("projectusers",{url:"/projectusers/:pid",templateUrl:"views/projectusers.html",controller:"MilestonesCtrl",data:{stateName:"Milestones"},resolve:{currentAuth:["Auth",function(a){return a.requireAuth()}]}}).state("tasks",{url:"/tasks/:mid",templateUrl:"views/tasks.html",controller:"TasksCtrl",data:{stateName:"Tasks"},resolve:{currentAuth:["Auth",function(a){return a.requireAuth()}]}}).state("talk",{url:"/talk",templateUrl:"views/talk.html",controller:"TalkCtrl",data:{stateName:"Talk"},resolve:{currentAuth:["Auth",function(a){return a.requireAuth()}]}}).state("contacts",{url:"/contacts",templateUrl:"views/contacts.html",controller:"ContactsCtrl",data:{stateName:"Contacts"},resolve:{currentAuth:["Auth",function(a){return a.requireAuth()}]}}).state("settings",{url:"/settings",templateUrl:"views/settings.html",controller:"SettingsCtrl",data:{stateName:"Settings"},resolve:{currentAuth:["Auth",function(a){return a.requireAuth()}]}})}]).run(["$state",function(a){}]);glance.config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("blue").accentPalette("orange")}]).config(["$mdDateLocaleProvider",function(a){a.formatDate=function(a){return moment(a).format("L")}}]),glance.directive("stateTitle",["$rootScope","$timeout",function(a,b){return{link:function(c,d){var e=function(a,c){var e="";c.data&&c.data.stateName&&(e=c.data.stateName),b(function(){d.text(e)},0,!1)};a.$on("$stateChangeSuccess",e)}}}]),glance.filter("capitalize",function(){return function(a,b){return null!=a?(a=a.toLowerCase(),a.substring(0,1).toUpperCase()+a.substring(1)):void 0}}),glance.controller("NavCtrl",["$scope","$state","$stateParams","$mdSidenav","Auth",function(a,b,c,d,e){a.currentUser=e.user,a.signedIn=e.signedIn,a.close=function(){d("left").close()},a.toggleNavbar=function(){d("left").toggle()},a.goGlanceboard=function(){b.go("glanceboard"),d("left").close()},a.goProjects=function(){b.go("projects"),d("left").close()},a.goTalk=function(){b.go("talk"),d("left").close()},a.goProfile=function(){b.go("contacts"),d("left").close()},a.goSettings=function(){b.go("settings"),d("left").close()},a.logout=function(){e.logout(),b.go("auth")}}]),glance.controller("AuthCtrl",["$scope","$state","$location","Auth",function(a,b,c,d){d.signedIn()&&b.transitionTo("glanceboard"),a.currentUser=d.user,a.register=function(a){d.register(a).then(function(a){b.go("projects")})["catch"](function(a){console.log("controller: Could not register")})},a.registerG=function(a){d.registerGoogle().then(function(){console.log("Logged in as: {{google.user}}")})["catch"](function(a){console.log("Google "+a)})},a.login=function(a){d.login(a).then(function(){b.go("glanceboard")})["catch"](function(a){console.log("Could not login")})},a.changePassword=function(a){d.changePassword(a).then(function(){console.log("Change password")},function(a){console.log("Could not change password")})}}]),glance.controller("GlanceCtrl",["$scope","Auth","Glance","Projects","Milestones","Tasks",function(a,b,c,d,e,f){var g=c.milestones();a.milestones=g;var h=c.tasks();a.tasks=h}]),glance.controller("ProjectsCtrl",["$scope","$state","FURL","Projects","$stateParams",function(a,b,c,d,e){a.projects=d.show(),a.selectProject=function(a){b.transitionTo("milestones",{pid:a.projectID}),console.log(a.projectID)},a.addProject=function(a){d.add(a)},a.updateProject=function(a,b){d.update(a,b)}}]),glance.controller("MilestonesCtrl",["$scope","$state","FURL","Milestones","$stateParams","Contacts",function(a,b,c,d,e,f){var g=e.pid,h=d.project(g);a.currentProject=h,a.contacts=f.show(),a.members=d.members(),a.milestones=d.show(g),a.selectMilestone=function(a){b.transitionTo("tasks",{mid:a.milestoneID}),console.log(a.milestoneID)},a.addMilestone=function(a,b){d.add(a,b)},a.updateProject=function(a,b){d.updateProject(a,b)},a.projectUsers=function(){b.transitionTo("projectusers",{pid:g})},a.addMember=function(a){d.inviteMember(h,a)},a.updateMilestone=function(a,b){d.update(a,b)}}]),glance.controller("TasksCtrl",["$scope","$state","FURL","Tasks","$stateParams",function(a,b,c,d,e){var f=e.mid;a.tasks=d.show(f),a.currentMilestone=d.milestone(f),a.selectTask=function(a,c){b.go("glanceboard")},a.addTask=function(a,b){d.add(a,b)},a.updateMilestone=function(a,b){d.updateMilestone(a,b)},a.updateTask=function(a,b){d.update(a,b)}}]),glance.controller("TalkCtrl",["$scope","FURL","Auth","$firebaseArray",function(a,b,c,d){var e=new Firebase(b),f=d(e.child("messages"));a.messages=f;var g=c.user;a.addMessage=function(a){f.$add(a)},a.test=function(){console.log(g)}}]),glance.controller("ContactsCtrl",["$scope","FURL","Contacts","Auth","$mdToast",function(a,b,c,d,e){a.contacts=c.show(),a.cancel=function(){ref.child("milestones").child(milestone.milestoneID).remove()},a.requests=c.reqShow(),a.acceptRequest=function(a){console.log(a),c.accept(a)},a.search=function(){c.searchEmail(a.email),a.email="",e.show(e.simple().content("Request send!"))}}]),glance.controller("SettingsCtrl",["$scope","User",function(a,b){a.update=function(c){b.updateImage(c),a.link=""}}]),glance.factory("Auth",["FURL","$firebaseAuth","$firebaseObject","$firebaseArray",function(a,b,c,d){var e=new Firebase(a),f=e.child("users"),g=b(e),h={user:{},createProfile:function(a,b){var c={firstName:b.firstName,lastName:b.lastName,email:b.email,uid:a,dateReg:Firebase.ServerValue.TIMESTAMP};return console.log(c)},getProfile:function(a){g.$onAuth(function(a){TheUser=a.uid,console.log("test",TheUser)})},login:function(a){return g.$authWithPassword({email:a.email,password:a.password},function(a,b){switch(a.code){case"INVALID_EMAIL":console.log("Log in with a valid email.");break;case"INVALID_PASSWORD":console.log("Password or email is incorrect");break;default:console.log("Enter a valid email and password")}}).then(function(a){console.log("login: Logged in with uid: ",a)})["catch"](function(a){alert("Error: "+a)})},register:function(a){return g.$createUser({email:a.email,password:a.password},function(a,b){if(a)switch(a.code){case"EMAIL_TAKEN":console.log("This email is in use, please choose a new email.");break;case"INVALID_TAKEN":console.log("Please choose a valid email.");break;default:console.log("Error creating user: ",a)}}).then(function(b){return a.uid=b.uid,h.login(a)}).then(function(b){var c=Math.floor(100*Math.random()+100);a.profileImage="https://unsplash.it/"+c;var d=a.uid;return delete a.password,a.dateReg=Firebase.ServerValue.TIMESTAMP,e.child("users").child(d).set(a)})["catch"](function(a){alert("Error: "+a)})},registerGoogle:function(a){return g.$authWithOAuthPopup("google").then(function(a){console.log(authData)})},logout:function(){g.$unauth()},changePassword:function(a){return g.$changePassword({email:a.email,oldPassword:a.oldPassword,newPassword:a.newPassword})},signedIn:function(){return!!h.user.provider},requireAuth:function(){return g.$requireAuth()}};return g.$onAuth(function(a){a?(angular.copy(a,h.user),h.user.userData=c(f.child(a.uid))):(h.user&&h.user.profile&&h.user.profile.$destroy(),angular.copy({},h.user))}),h}]),glance.factory("Glance",["FURL","Auth","$firebaseObject","$firebaseArray","$timeout",function(a,b,c,d,e){var f=new Firebase(a),g=(d(f.child("projects")),d(f.child("milestones")),f.child("users")),h=f.child("projects"),i=f.getAuth().uid,j={projects:function(){var a=d(g.child(i).child("projects")),b=[];return a.$loaded().then(function(){angular.forEach(a,function(a,c){b.push(a.projectID)})}),b},milestones:function(){var a=j.projects(),b=[];a.length;return e(function(){for(var c=0;c<a.length;c++){var e=d(h.child(a[c]).child("milestones"));e.$loaded(function(a){return a.forEach(function(a){var c=(new Date).getTime(),d=(a.deadline-c)/864e5,e=a.priority/d;a.order=e,b.push(a)}),b}).then(function(a){b=a,b.sort(function(a,b){return parseFloat(b.order)-parseFloat(a.order)}),console.log(b)})}},1e3),b},tasks:function(){var a=j.projects(),b=[];a.length;return e(function(){for(var c=0;c<a.length;c++){var e=d(h.child(a[c]).child("tasks"));e.$loaded(function(a){return a.forEach(function(a){var c=(new Date).getTime(),d=(a.deadline-c)/864e5,e=a.priority/d;a.order=e,b.push(a)}),b}).then(function(a){b=a,b.sort(function(a,b){return parseFloat(b.order)-parseFloat(a.order)})})}},1e3),b}};return j}]),glance.factory("Projects",["FURL","Auth","$mdDialog","$firebaseAuth","$firebaseObject","$firebaseArray","$filter",function(a,b,c,d,e,f,g){var h=new Firebase(a),i=f(h.child("projects")),j=h.child("users"),k=h.getAuth().uid,l=(d(h),{show:function(){return e(j.child(k).child("projects"))},add:function(a,d){return c.show({clickOutsideToClose:!0,controller:["$mdDialog",function(a){var c=this;c.project=d,c.add=function(c){c.creator=b.user.uid,c.admin=b.user.uid,c.startDate=Firebase.ServerValue.TIMESTAMP,c.completed=!1;var d=new Date;c.deadline=d.getTime()+24192e5;var e=Math.floor(100*Math.random()+200);c.image="https://unsplash.it/"+e,null==c.description&&(c.description=""),null==c.priority&&(c.priority=0),void 0==c.deadline&&(c.deadline=null),i.$add(c).then(function(a){var d={projectID:a.key(),title:c.title,description:c.description,image:c.image,completed:!1},e={uid:b.user.userData.uid,email:b.user.userData.email,firstName:b.user.userData.firstName,lastName:b.user.userData.lastName};return j.child(b.user.uid).child("projects").child(d.projectID).set(d),h.child("projects").child(d.projectID).child("members").child(b.user.uid).set(e),a}),console.log(c),a.hide()},c.closeDialog=function(){console.log("deleter"),a.hide()}}],controllerAs:"PAmodal",templateUrl:"views/newproject.html",targetEvent:a})},update:function(a,b){return c.show({clickOutsideToClose:!0,controller:["$mdDialog",function(a){var c=this;c.project={},c.project=b,console.log(c.project),c.update=function(){h.child("projects").child(b.$id).update({title:b.title,description:b.description,priority:b.priority,deadline:b.deadline}),console.log("Updated to: "+b.title+b.description),a.hide()},c.closeDialog=function(){console.log("delete"),j.child(k).child("projects").child(b.$id).remove(),a.hide()}}],controllerAs:"PEmodal",templateUrl:"views/updateproject.html",parent:angular.element(document.body),targetEvent:a})}});return l}]),glance.factory("Milestones",["FURL","Auth","$mdDialog","$firebaseAuth","$firebaseObject","$firebaseArray","$stateParams",function(a,b,c,d,e,f,g){var h=new Firebase(a),i=f(h.child("milestones")),j=h.child("projects"),k=g.pid,l=(d(h),{project:function(a){return e(j.child(a))},updateProject:function(a,b){return c.show({clickOutsideToClose:!0,controller:["$mdDialog",function(a){var c=this;c.project={},c.project=b;var d=g.pid;c.update=function(){h.child("projects").child(d).update({title:c.project.title,description:c.project.description,priority:c.project.priority}),a.hide()}}],controllerAs:"PEmodal",templateUrl:"views/updateproject.html",parent:angular.element(document.body),targetEvent:a})},members:function(){return e(j.child(k).child("members"))},inviteMember:function(a,b){var c={};c.email=b.email,c.uid=b.uid,c.firstName=b.firstName,c.lastName=b.lastName;var d={};d.projectID=a.$id,d.title=a.title,d.description=a.description,d.completed=a.completed,d.image=a.image,j.child(a.$id).child("members").child(b.uid).set(c),h.child("users").child(b.uid).child("projects").child(a.$id).set(d)},show:function(a){return e(j.child(a).child("milestones"))},add:function(a,d){return c.show({clickOutsideToClose:!0,controller:["$mdDialog",function(a){var c=this;c.milestone=d,c.add=function(c){var d=g.pid;c.creator=b.user.uid,c.admin=b.user.uid,c.startDate=Firebase.ServerValue.TIMESTAMP,c.completed=!1,c.projectID=d;var e=new Date;c.deadline=e.getTime()+12096e5;var f=Math.floor(100*Math.random()+200);c.image="https://unsplash.it/"+f,null==c.description&&(c.description=""),null==c.priority&&(c.priority=0),i.$add(c).then(function(a){var b={milestoneID:a.key(),title:c.title,description:c.description,image:c.image,priority:c.priority,deadline:c.deadline};return j.child(d).child("milestones").child(b.milestoneID).set(b),a}),a.hide()},c.closeDialog=function(){a.hide()}}],controllerAs:"MAmodal",templateUrl:"views/newmilestone.html",targetEvent:a})},update:function(a,b){return c.show({clickOutsideToClose:!0,controller:["$mdDialog",function(a){var c=this;c.milestone={},c.milestone=b;var d=g.pid;c.update=function(){h.child("milestones").child(b.milestoneID).update({title:c.milestone.title,description:c.milestone.description,priority:c.milestone.priority,deadline:c.milestone.deadline}),j.child(d).child("milestones").child(b.milestoneID).update({title:c.milestone.title,description:c.milestone.description,priority:c.milestone.priority}),a.hide()},c.closeDialog=function(){h.child("milestones").child(b.milestoneID).remove(),j.child(d).child("milestones").child(b.milestoneID).remove(),a.hide()}}],controllerAs:"MEmodal",templateUrl:"views/updatemilestone.html",parent:angular.element(document.body),targetEvent:a})}});return l}]),glance.factory("Tasks",["FURL","Auth","$mdDialog","$firebaseAuth","$firebaseObject","$firebaseArray","$stateParams",function(a,b,c,d,e,f,g){var h=new Firebase(a),i=f(h.child("tasks")),j=h.child("projects"),k=h.child("milestones"),l=(g.mid,d(h),{milestone:function(a){return e(k.child(a))},updateMilestone:function(a,b){return c.show({clickOutsideToClose:!0,controller:["$mdDialog",function(a){var c=this;c.milestone={},c.milestone=b;var d=g.mid;c.update=function(){k.child(d).update({title:c.milestone.title,description:c.milestone.description,priority:c.milestone.priority,deadline:c.milestone.deadline});var b=e(k.child(d).child("projectID"));b.$loaded(function(a){var b=a.$value;j.child(b).child("milestones").child(d).update({title:c.milestone.title,description:c.milestone.description,priority:c.milestone.priority,deadline:c.milestone.deadline})}),a.hide()},c.remove=function(){var b=e(k.child(d));b.$loaded(function(a){j.child(a.projectID).child("milestones").child(d).remove(),k.child(d).remove()}),a.hide()}}],controllerAs:"MEmodal",templateUrl:"views/updatemilestone.html",parent:angular.element(document.body),targetEvent:a})},show:function(a){return e(k.child(a).child("tasks"))},add:function(a,d){return c.show({clickOutsideToClose:!0,controller:["$mdDialog",function(a){var c=this;c.task=d,c.add=function(c){var d=g.mid;c.creator=b.user.uid,c.admin=b.user.uid,c.startDate=Firebase.ServerValue.TIMESTAMP,c.completed=!1,c.milestoneID=d;var f=new Date;c.deadline=f.getTime()+6048e5;var h=Math.floor(100*Math.random()+200);c.image="https://unsplash.it/"+h,null==c.description&&(c.description=""),null==c.priority&&(c.priority=0),i.$add(c).then(function(a){var b={taskID:a.key(),title:c.title,description:c.description,priority:c.priority,image:c.image,deadline:c.deadline};k.child(d).child("tasks").child(b.taskID).set(b),console.log("mid",d);var f=e(k.child(d).child("projectID"));return f.$loaded(function(a){var c=a.$value;j.child(c).child("tasks").child(b.taskID).set(b)}),a}),console.log(c),a.hide()},c.closeDialog=function(){console.log("deleter"),a.hide()}}],controllerAs:"TAmodal",templateUrl:"views/newtask.html",targetEvent:a})},update:function(a,b){return c.show({clickOutsideToClose:!0,controller:["$mdDialog",function(a){var c=this;c.task={},c.task=b,console.log(b);var d=g.mid;c.update=function(){h.child("tasks").child(b.taskID).update({title:c.task.title,description:c.task.description,priority:c.task.priority,deadline:c.task.deadline}),k.child(d).child("tasks").child(b.taskID).update({title:c.task.title,description:c.task.description,priority:c.task.priority});var f=e(k.child(d).child("projectID"));f.$loaded(function(a){var d=a.$value;j.child(d).child("tasks").child(b.taskID).update({title:c.task.title,description:c.task.description,priority:c.task.priority,deadline:c.task.deadline})}),console.log("Updated to: "+b.title+b.description),a.hide()},c.closeDialog=function(){h.child("tasks").child(b.taskID).remove(),k.child(d).child("tasks").child(b.taskID).remove();var c=e(k.child(d).child("projectID"));c.$loaded(function(a){var c=a.$value;j.child(c).child("tasks").child(b.taskID).remove()}),a.hide()}}],controllerAs:"TEmodal",templateUrl:"views/updatetask.html",parent:angular.element(document.body),targetEvent:a})}});return l}]),glance.factory("User",["FURL","$firebaseArray","$timeout","$q",function(a,b,c,d){var e=new Firebase(a),f=(e.child("projects"),e.getAuth().uid),g={updateImage:function(a){return e.child("users").child(f).child("profileImage").set(a)}};return g}]),glance.factory("Talk",function(){}),glance.factory("Contacts",["FURL","Auth","$firebaseObject","$firebaseArray",function(a,b,c,d){var e=new Firebase(a),f=e.child("users").orderByChild("email"),g=e.getAuth().uid,h={show:function(){return c(e.child("users").child(g).child("contacts"))},showa:function(){return d(e.child("users").child(g).child("contacts"))},reqShow:function(){return c(e.child("users").child(g).child("requests"))},accept:function(a){var c=b.user.userData;console.log(a),console.log(a.uid),console.log(c);var d={};d.email=c.email,d.uid=c.uid,d.firstName=c.firstName,d.lastName=c.lastName,d.profileImage=c.profileImage,console.log(d),e.child("users").child(g).child("contacts").child(a.uid).set(a),e.child("users").child(a.uid).child("contacts").child(a.uid).push(d),e.child("users").child(g).child("requests").child(a.uid).remove()},searchEmail:function(a){f.startAt(a).endAt(a).once("value",function(a){a.forEach(function(a){var b=a.key();h.sendRequest(b)})})},sendRequest:function(a){var c=b.user.userData,d={};return d.uid=c.$id,d.email=c.email,d.firstName=c.firstName,d.lastName=c.lastName,d.profileImage=c.profileImage,console.log(d),console.log(a),e.child("users").child(a).child("requests").child(d.uid).push(d)}};return h}]);